# 知识图谱构建Agent接口描述文档
## 1. 接口基本信息
### 1.1 仅查询数据库图谱接口
| 字段         | 说明                                             |
|--------------|------------------------------------------------|
| 接口名称     | 知识图谱数据库查询接口                                  |
| 接口路径     | `/api/kg/query-db`                              |
| 请求方法     | POST                                           |
| 接口描述     | 输入学科概念，仅查询数据库中已有的合法知识图谱（无LLM调用，直接访问Neo4j） |
| 响应格式     | JSON                                           |
| 接口版本     | v1.0                                           |
| 超时时间     | 5s（仅数据库查询操作，响应速度快）                  |

### 1.2 知识图谱生成接口
| 字段         | 说明                                             |
|--------------|------------------------------------------------|
| 接口名称     | 跨学科知识图谱自动生成接口                                  |
| 接口路径     | `/api/kg/generate`                              |
| 请求方法     | POST                                           |
| 接口描述     | 输入学科概念，调用Agent生成跨学科知识图谱（包含LLM调用、数据库操作） |
| 响应格式     | JSON                                           |
| 接口版本     | v1.0                                           |
| 超时时间     | 300s（因包含LLM调用+数据库操作，建议设置较长超时）                  |

## 2. 请求参数说明
### 2.1 请求头（Header）
| 参数名       | 必选 | 类型   | 说明                     | 示例值               |
|--------------|------|--------|--------------------------|----------------------|
| Content-Type | 是   | string | 请求体格式               | application/json     |
| Accept       | 是   | string | 响应格式                 | application/json     |

### 2.2 请求体（Body）
| 参数名   | 必选 | 类型   | 说明                                                                 | 示例值 |
|----------|------|--------|----------------------------------------------------------------------|--------|
| concept  | 是   | string | 待查询/生成图谱的核心学科概念<br/>- 仅支持中文/英文/数字/常见学科符号<br/>- 需为具体学科概念（如“熵”“神经网络”）<br/>- 长度限制：≤20字 | 熵     |

### 2.3 请求示例
```json
{
  "concept": "熵"
}
```

## 3. 响应参数说明
### 3.1 响应状态码
| 状态码 | 说明                     | 场景示例                                   |
|--------|--------------------------|--------------------------------------------|
| 200    | 成功                     | 概念有效，查询/生成图谱完成                |
| 400    | 输入参数无效             | 概念为空/长度超过20字/无意义词汇           |
| 500    | 服务器内部错误           | 数据库连接异常/LLM调用失败（仅generate接口）|

### 3.2 响应体字段
#### 3.2.1 仅查询数据库图谱接口（/api/kg/query-db）
| 一级字段     | 类型   | 说明                     | 二级字段                  | 类型    | 说明                                                                 |
|--------------|--------|--------------------------|---------------------------|---------|----------------------------------------------------------------------|
| code         | int    | 响应状态码               | -                         | -       | 200/400/500                                                          |
| msg          | string | 响应信息                 | -                         | -       | 成功/失败提示信息                                                    |
| data         | object | 核心返回数据（200时返回） | nodes                     | array   | 知识图谱节点列表                                                     |
| -            | -      | -                        | nodes[].name              | string  | 节点名称（概念名）                                                   |
| -            | -      | -                        | nodes[].domain            | string  | 节点所属领域（如“物理”“计算机”“未知”）                              |
| -            | -      | -                        | links                     | array   | 知识图谱关联边列表                                                   |
| -            | -      | -                        | links[].source            | string  | 源节点（核心概念）                                                   |
| -            | -      | -                        | links[].target            | string  | 目标节点（关联概念）                                                 |
| -            | -      | -                        | links[].relation          | string  | 关联逻辑描述（具体科学依据）                                         |
| -            | -      | -                        | links[].strength          | int     | 关联强度（1-5，越高相关性越强）                                      |
| -            | -      | -                        | reasoning                 | array   | 查询过程日志                                                        |
| -            | -      | -                        | cleaned_relations         | array   | 清理的不合理旧关联列表                                               |
| has_data     | bool   | 是否有有效数据（前端判断关键） | -                         | -       | true/false                                                           |

#### 3.2.2 知识图谱生成接口（/api/kg/generate）
| 一级字段     | 类型   | 说明                     | 二级字段                  | 类型    | 说明                                                                 |
|--------------|--------|--------------------------|---------------------------|---------|----------------------------------------------------------------------|
| code         | int    | 响应状态码               | -                         | -       | 200/400/500                                                          |
| msg          | string | 响应信息                 | -                         | -       | 成功/失败提示信息（包含节点/关联数量）                               |
| data         | object | 核心返回数据（200时返回） | nodes                     | array   | 知识图谱节点列表                                                     |
| -            | -      | -                        | nodes[].name              | string  | 节点名称（概念名）                                                   |
| -            | -      | -                        | nodes[].domain            | string  | 节点所属领域（如“物理”“计算机”“未知”）                              |
| -            | -      | -                        | links                     | array   | 知识图谱关联边列表                                                   |
| -            | -      | -                        | links[].source            | string  | 源节点（核心概念）                                                   |
| -            | -      | -                        | links[].target            | string  | 目标节点（关联概念）                                                 |
| -            | -      | -                        | links[].relation          | string  | 关联逻辑描述（具体科学依据）                                         |
| -            | -      | -                        | links[].strength          | int     | 关联强度（1-5，越高相关性越强）                                      |
| -            | -      | -                        | reasoning                 | array   | Agent推理过程日志（分步记录）                                        |
| -            | -      | -                        | cleaned_relations         | array   | 清理的不合理旧关联列表                                               |

### 3.3 响应示例
#### 3.3.1 仅查询数据库接口 - 成功响应（200，有数据）
```json
{
  "code": 200,
  "data": {
    "nodes": [
      {"name": "熵", "domain": "物理"},
      {"name": "信息熵", "domain": "计算机"}
    ],
    "links": [
      {
        "source": "熵",
        "target": "信息熵",
        "relation": "热力学熵描述系统混乱度，信息熵量化信息不确定性，两者数学形式同构",
        "strength": 5
      }
    ],
    "reasoning": [
      "仅查库：获取熵的已有关联数据",
      "仅查库：共2个节点，1条合法关联"
    ],
    "cleaned_relations": [],
    "msg": "数据库查询成功",
    "has_data": true
  },
  "msg": "数据库查询成功",
  "has_data": true
}
```

#### 3.3.2 仅查询数据库接口 - 成功响应（200，无数据）
```json
{
  "code": 200,
  "data": {
    "nodes": [
      {"name": "测试概念", "domain": "未知"}
    ],
    "links": [],
    "reasoning": [
      "仅查库：未查询到测试概念的已有关联数据"
    ],
    "cleaned_relations": [],
    "msg": "数据库查询成功",
    "has_data": false
  },
  "msg": "数据库查询成功",
  "has_data": false
}
```

#### 3.3.3 仅查询数据库接口 - 失败响应（400）
```json
{
  "code": 400,
  "detail": "核心概念不能为空"
}
```

#### 3.3.4 仅查询数据库接口 - 失败响应（500）
```json
{
  "code": 500,
  "detail": "查询数据库失败：Neo4j数据库连接超时"
}
```

#### 3.3.5 生成接口 - 成功响应（200）
```json
{
  "code": 200,
  "data": {
    "nodes": [
      {"name": "熵", "domain": "物理"},
      {"name": "信息熵", "domain": "计算机"},
      {"name": "热力学第二定律", "domain": "物理"}
    ],
    "links": [
      {
        "source": "熵",
        "target": "信息熵",
        "relation": "热力学熵与信息熵数学形式同构，信息熵借鉴热力学熵概念量化信息不确定性",
        "strength": 5
      },
      {
        "source": "熵",
        "target": "热力学第二定律",
        "relation": "熵是热力学第二定律核心物理量，熵增原理揭示过程方向性",
        "strength": 5
      }
    ],
    "reasoning": [
      "0. 输入校验通过：熵是热力学核心学科概念",
      "1. 查库：获取熵的已有关联",
      "2. 扩展：生成新关联",
      "3. 校验：关联合法性验证通过",
      "4. 存库：保存合法关联到数据库"
    ],
    "cleaned_relations": []
  },
  "msg": "成功生成3个节点、2条合法关联"
}
```

#### 3.3.6 生成接口 - 失败响应（400）
```json
{
  "code": 400,
  "detail": "核心概念长度不能超过20字"
}
```

#### 3.3.7 生成接口 - 失败响应（500）
```json
{
  "code": 400,
  "detail": "生成失败：LLM调用失败，无法扩展跨学科关联"
}
```

## 4. 接口调用注意事项
1. **参数限制**：
   - `concept`参数长度严格≤20字，仅支持中文/英文/数字/常见学科符号（α、β、∑等）；
   - 需为具体学科概念（如“熵”“神经网络”），不支持无意义词汇（如“测试123”）。
2. **频率限制**：
   - `/api/kg/query-db`：仅数据库操作，调用频率无严格限制（建议≤100次/分钟）；
   - `/api/kg/generate`：因包含LLM调用，建议调用频率≤10次/分钟。
3. **依赖说明**：
   - 两个接口均依赖Neo4j数据库（存储知识图谱）；
   - `/api/kg/generate`额外依赖大模型服务（LLM，用于关联扩展/校验），需确保依赖服务正常运行。
4. **重试机制**：
   - `/api/kg/query-db`：数据库查询失败时建议外部重试（最多3次，间隔1s）；
   - `/api/kg/generate`：接口内部已实现LLM调用重试（最多3次），外部无需额外重试。
5. **数据说明**：
   - `/api/kg/generate`生成的合法关联会自动保存到Neo4j数据库，后续调用`/api/kg/query-db`可查询到该数据；
   - 查询接口仅返回数据库中已有的合法关联，不会触发LLM调用和数据扩展。

## 5. 接口核心能力说明
| 接口路径          | 核心能力点               | 说明                                                                 |
|-------------------|--------------------------|----------------------------------------------------------------------|
| `/api/kg/query-db` | 快速数据库查询           | 无LLM调用，响应速度快，仅返回数据库中已有的知识图谱数据               |
|                   | 数据有效性标识           | 通过`has_data`字段明确返回是否有有效关联数据，便于前端逻辑判断         |
|                   | 基础参数校验             | 接口层前置校验空值、长度，避免无效数据库查询                         |
| `/api/kg/generate` | 跨学科关联扩展           | 基于LLM自动生成跨学科关联，丰富知识图谱维度                           |
|                   | 关联合法性校验           | 反幻觉设计，校验关联逻辑的科学性，过滤编造/无依据的关联               |
|                   | 数据持久化               | 生成的合法关联自动保存到Neo4j，支持后续查询复用                       |
|                   | 生成结果量化             | 响应信息包含节点/关联数量，便于前端展示生成效果                       |