version: '3.8'

services:
  # 后端FastAPI服务
  backend:
    build: ./backend  # 指向Dockerfile所在目录
    ports:
      - "8000:8000"  # 前端访问后端的端口
    # 合并所有环境变量到一个environment字段（解决重复定义问题）
    environment:
      # 大模型配置
      - LLM_API_KEY="sk-eeguuqrgdxpamorwpxmypfmmmkycsycchvrfitekxtatioqr"
      # Neo4j数据库配置（密码改为8位）
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=12345678
      # Python路径配置
      - PYTHONPATH=/app
    depends_on:
      - neo4j  # 确保先启动Neo4j，再启动后端
    restart: always  # 服务挂了自动重启
    volumes:
      - ./backend:/app  # 挂载本地代码到容器
    working_dir: /app  # 容器内工作目录

  # Neo4j图数据库服务
  neo4j:
    image: neo4j:5.15-community
    ports:
      - "7474:7474"
      - "7687:7687"
    environment:
      - NEO4J_AUTH=neo4j/12345678
      - NEO4J_PLUGINS=["apoc"]
      - NEO4J_dbms_security_procedures_unrestricted=apoc.*
    volumes:
      - neo4j-data:/data
    restart: always
    # 覆盖启动命令，解决进程冲突
    command: [ "neo4j", "console" ]
    # Windows 下添加特权模式，避免权限问题
    privileged: true

# 数据卷：持久化Neo4j数据
volumes:
  neo4j-data: